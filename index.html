<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<!-- No cache for testing -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Asteroids – Final</title>

<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: monospace;
    text-align: center;
  }
  canvas {
    display: block;
    margin: 20px auto;
    border: 4px solid white;
    background: black;
  }
</style>
</head>

<body>
<h1>Asteroids</h1>
<p>↑ thrust · ← → rotate · Space fire</p>

<canvas id="game" width="512" height="512"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* INPUT */
const keys = {};
addEventListener("keydown", e => keys[e.key] = true);
addEventListener("keyup", e => keys[e.key] = false);

/* CONSTANTS */
const W = 512;
const H = 512;
const GRAVITY = 0.03;
const DAMPING = 0.995;

/* GAME STATE */
let ship, bullets, asteroids;
let dead = false;
let resetTimer = 0;

/* WRAP */
function wrap(o, r = 0) {
  if (o.x < -r) o.x = W + r;
  if (o.x > W + r) o.x = -r;
  if (o.y < -r) o.y = H + r;
  if (o.y > H + r) o.y = -r;
}

/* RESET */
function resetGame() {
  ship = {
    x: W / 2,
    y: H / 2,
    vx: 0,
    vy: 0,
    angle: -Math.PI / 2,
    radius: 12,
    thrust: 0.15,
    rotationSpeed: 0.05,
    cooldown: 0
  };

  bullets = [];
  asteroids = [];
  for (let i = 0; i < 5; i++) spawnAsteroid(40);

  dead = false;
}

/* ASTEROIDS */
function spawnAsteroid(size, x, y) {
  if (x === undefined) {
    const edge = Math.floor(Math.random() * 4);
    if (edge === 0) { x = 0; y = Math.random() * H; }
    if (edge === 1) { x = W; y = Math.random() * H; }
    if (edge === 2) { x = Math.random() * W; y = 0; }
    if (edge === 3) { x = Math.random() * W; y = H; }
  }

  asteroids.push({
    x, y,
    size,
    vx: (Math.random() - 0.5) * (60 / size),
    vy: (Math.random() - 0.5) * (60 / size)
  });
}

resetGame();

/* LOOP */
function loop() {

  /* CLEAR */
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, W, H);

  /* DEBUG MARKER */
  ctx.fillStyle = "magenta";
  ctx.fillRect(4, 4, 8, 8);

  /* SHIP UPDATE */
  if (!dead) {
    if (keys["ArrowLeft"]) ship.angle -= ship.rotationSpeed;
    if (keys["ArrowRight"]) ship.angle += ship.rotationSpeed;

    if (keys["ArrowUp"]) {
      ship.vx += Math.cos(ship.angle) * ship.thrust;
      ship.vy += Math.sin(ship.angle) * ship.thrust;
    }

    ship.vy += GRAVITY;
    ship.vx *= DAMPING;
    ship.vy *= DAMPING;

    ship.x += ship.vx;
    ship.y += ship.vy;
    wrap(ship, ship.radius);

    if (keys[" "] && ship.cooldown <= 0) {
      bullets.push({
        x: ship.x,
        y: ship.y,
        vx: Math.cos(ship.angle) * 6,
        vy: Math.sin(ship.angle) * 6,
        life: 90
      });
      ship.cooldown = 10;
    }
    ship.cooldown--;
  }

  /* BULLETS */
  for (let b of bullets) {
    b.x += b.vx;
    b.y += b.vy;
    b.life--;
    wrap(b, 2);
  }
  bullets = bullets.filter(b => b.life > 0);

  /* ASTEROIDS */
  for (let a of asteroids) {
    a.x += a.vx;
    a.y += a.vy;
    wrap(a, a.size);
  }

  /* BULLET ↔ ASTEROID */
  for (let i = bullets.length - 1; i >= 0; i--) {
    for (let j = asteroids.length - 1; j >= 0; j--) {
      const b = bullets[i];
      const a = asteroids[j];
      if (Math.hypot(b.x - a.x, b.y - a.y) < a.size) {
        bullets.splice(i, 1);
        asteroids.splice(j, 1);

        if (a.size > 30) {
          spawnAsteroid(a.size / 2, a.x, a.y);
          spawnAsteroid(a.size / 2, a.x, a.y);
        }
        break;
      }
    }
  }

  /* SHIP ↔ ASTEROID */
  if (!dead) {
    for (let a of asteroids) {
      if (Math.hypot(ship.x - a.x, ship.y - a.y) < ship.radius + a.size) {
        dead = true;
        resetTimer = 60;
        break;
      }
    }
  } else {
    resetTimer--;
    if (resetTimer <= 0) resetGame();
  }

  /* DRAW SHIP */
  if (!dead) {
    ctx.save();
    ctx.translate(ship.x, ship.y);
    ctx.rotate(ship.angle);
    ctx.strokeStyle = "cyan";
    ctx.beginPath();
    ctx.moveTo(12, 0);
    ctx.lineTo(-10, -8);
    ctx.lineTo(-6, 0);
    ctx.lineTo(-10, 8);
    ctx.closePath();
    ctx.stroke();
    ctx.restore();
  }

  /* DRAW BULLETS */
  ctx.fillStyle = "white";
  for (let b of bullets) {
    ctx.fillRect(b.x - 2, b.y - 2, 4, 4);
  }

  /* DRAW ASTEROIDS */
  ctx.strokeStyle = "gray";
  for (let a of asteroids) {
    ctx.beginPath();
    ctx.arc(a.x, a.y, a.size, 0, Math.PI * 2);
    ctx.stroke();
  }

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
