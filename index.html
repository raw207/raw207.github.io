<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<!-- Disable cache for testing -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Layer 4 – Gravity</title>

<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: monospace;
    text-align: center;
  }
  canvas {
    display: block;
    margin: 20px auto;
    border: 4px solid white;
    background: black;
  }
</style>
</head>

<body>
<h1>Layer 4: Gravity</h1>
<p>Arrow keys thrust · Space fires</p>

<canvas id="game" width="512" height="512"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* INPUT */
const keys = {};
addEventListener("keydown", e => keys[e.key] = true);
addEventListener("keyup", e => keys[e.key] = false);

/* CONSTANTS */
const GRAVITY = 0.05;
const DAMPING = 0.995;

/* SHIP */
const ship = {
  x: 256,
  y: 256,
  vx: 0,
  vy: 0,
  thrust: 0.15,
  cooldown: 0
};

/* BULLETS */
const bullets = [];

/* ASTEROIDS */
const asteroids = [];
const ASTEROID_COUNT = 6;

function spawnAsteroid() {
  const edge = Math.floor(Math.random() * 4);
  let x, y;

  if (edge === 0) { x = 0; y = Math.random() * 512; }
  if (edge === 1) { x = 512; y = Math.random() * 512; }
  if (edge === 2) { x = Math.random() * 512; y = 0; }
  if (edge === 3) { x = Math.random() * 512; y = 512; }

  asteroids.push({
    x,
    y,
    vx: (Math.random() - 0.5) * 1.5,
    vy: (Math.random() - 0.5) * 1.5,
    size: 20 + Math.random() * 15
  });
}

for (let i = 0; i < ASTEROID_COUNT; i++) spawnAsteroid();

/* LOOP */
function loop() {

  /* CLEAR */
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, 512, 512);

  /* DEBUG MARKER */
  ctx.fillStyle = "magenta";
  ctx.fillRect(4, 4, 8, 8);

  /* INPUT → VELOCITY */
  if (keys["ArrowUp"]) ship.vy -= ship.thrust;
  if (keys["ArrowDown"]) ship.vy += ship.thrust;
  if (keys["ArrowLeft"]) ship.vx -= ship.thrust;
  if (keys["ArrowRight"]) ship.vx += ship.thrust;

  /* GRAVITY */
  ship.vy += GRAVITY;

  /* DAMPING */
  ship.vx *= DAMPING;
  ship.vy *= DAMPING;

  /* POSITION */
  ship.x += ship.vx;
  ship.y += ship.vy;

  /* FIRE */
  if (keys[" "] && ship.cooldown <= 0) {
    bullets.push({
      x: ship.x,
      y: ship.y,
      vy: -6,
      life: 60
    });
    ship.cooldown = 10;
  }
  ship.cooldown--;

  /* SCREEN CLAMP */
  ship.x = Math.max(10, Math.min(502, ship.x));
  ship.y = Math.max(10, Math.min(502, ship.y));

  /* BULLETS */
  for (let b of bullets) {
    b.y += b.vy;
    b.life--;
  }

  /* ASTEROIDS */
  for (let a of asteroids) {
    a.x += a.vx;
    a.y += a.vy;

    if (a.x < -a.size) a.x = 512 + a.size;
    if (a.x > 512 + a.size) a.x = -a.size;
    if (a.y < -a.size) a.y = 512 + a.size;
    if (a.y > 512 + a.size) a.y = -a.size;
  }

  /* BULLET ↔ ASTEROID COLLISIONS */
  for (let i = bullets.length - 1; i >= 0; i--) {
    for (let j = asteroids.length - 1; j >= 0; j--) {
      const b = bullets[i];
      const a = asteroids[j];
      const dx = b.x - a.x;
      const dy = b.y - a.y;
      const dist = Math.sqrt(dx*dx + dy*dy);

      if (dist < a.size) {
        bullets.splice(i, 1);
        asteroids.splice(j, 1);
        spawnAsteroid();
        break;
      }
    }
  }

  /* CLEAN BULLETS */
  for (let i = bullets.length - 1; i >= 0; i--) {
    if (bullets[i].life <= 0) bullets.splice(i, 1);
  }

  /* DRAW SHIP */
  ctx.fillStyle = "cyan";
  ctx.fillRect(ship.x - 10, ship.y - 10, 20, 20);

  /* DRAW BULLETS */
  ctx.fillStyle = "white";
  for (let b of bullets) {
    ctx.fillRect(b.x - 2, b.y - 6, 4, 8);
  }

  /* DRAW ASTEROIDS */
  ctx.strokeStyle = "gray";
  for (let a of asteroids) {
    ctx.beginPath();
    ctx.arc(a.x, a.y, a.size, 0, Math.PI * 2);
    ctx.stroke();
  }

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
