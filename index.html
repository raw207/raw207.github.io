<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<!-- No cache for testing -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Asteroids â€“ Mobile Ready</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  overflow: hidden;
  font-family: monospace;
}

#hud {
  position: fixed;
  top: 10px;
  left: 10px;
  color: white;
  z-index: 10;
  pointer-events: none;
}

canvas {
  display: block;
}
</style>
</head>

<body>

<div id="hud">
  <div id="score">SCORE: 0</div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* INPUT */
const keys = {};
const touch = { left:false, right:false, thrust:false, fire:false };

addEventListener("keydown", e => keys[e.key] = true);
addEventListener("keyup", e => keys[e.key] = false);

/* TOUCH CONTROLS */
canvas.addEventListener("touchstart", handleTouch, { passive:false });
canvas.addEventListener("touchmove", handleTouch, { passive:false });
canvas.addEventListener("touchend", clearTouch, { passive:false });

function handleTouch(e) {
  e.preventDefault();
  clearTouch();
  for (let t of e.touches) {
    const x = t.clientX;
    const y = t.clientY;

    if (x < W * 0.33) touch.left = true;
    else if (x > W * 0.66) touch.right = true;
    else if (y > H * 0.6) touch.thrust = true;
    else touch.fire = true;
  }
}

function clearTouch() {
  touch.left = touch.right = touch.thrust = touch.fire = false;
}

/* SIZE */
let W, H;
function resize() {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
}
addEventListener("resize", resize);
resize();

/* CONSTANTS */
const GRAVITY = 0.03;
const DAMPING = 0.995;

/* GAME STATE */
let ship, bullets, asteroids, particles, stars;
let dead = false;
let resetTimer = 0;
let score = 0;

/* AUDIO */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq, time) {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.frequency.value = freq;
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + time);
  o.stop(audioCtx.currentTime + time);
}

/* HELPERS */
function wrap(o, r=0) {
  if (o.x < -r) o.x = W + r;
  if (o.x > W + r) o.x = -r;
  if (o.y < -r) o.y = H + r;
  if (o.y > H + r) o.y = -r;
}

function asteroidShape(size) {
  const pts=[];
  const v=Math.floor(Math.random()*5)+7;
  for(let i=0;i<v;i++){
    const a=i/v*Math.PI*2;
    pts.push({a,r:size*(0.6+Math.random()*0.5)});
  }
  return pts;
}

/* RESET */
function resetGame() {
  ship = {
    x:W/2, y:H/2, vx:0, vy:0,
    angle:-Math.PI/2,
    radius:12, thrust:0.15,
    rotation:0.05, cooldown:0
  };

  bullets=[];
  asteroids=[];
  particles=[];
  stars=[];

  for(let i=0;i<6;i++) spawnAsteroid(50);
  for(let i=0;i<W*H/12000;i++)
    stars.push({x:Math.random()*W,y:Math.random()*H,s:Math.random()*0.3+0.1});

  score=0;
  dead=false;
}

/* ASTEROIDS */
function spawnAsteroid(size,x,y){
  if(x==null){
    const e=Math.floor(Math.random()*4);
    x=e<2?Math.random()*W:(e===2?0:W);
    y=e>=2?Math.random()*H:(e===0?0:H);
  }
  asteroids.push({
    x,y,size,
    vx:(Math.random()-0.5)*(70/size),
    vy:(Math.random()-0.5)*(70/size),
    a:Math.random()*Math.PI*2,
    s:(Math.random()-0.5)*0.01,
    shape:asteroidShape(size)
  });
}

/* EXPLOSION */
function explode(x,y,n){
  for(let i=0;i<n;i++)
    particles.push({x,y,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4,l:Math.random()*40+20});
}

resetGame();

/* LOOP */
function loop() {
  ctx.fillStyle="black";
  ctx.fillRect(0,0,W,H);

  /* STARS */
  ctx.fillStyle="white";
  stars.forEach(s=>{
    s.y+=s.s;
    if(s.y>H)s.y=0;
    ctx.fillRect(s.x,s.y,1,1);
  });

  /* SHIP INPUT */
  if(!dead){
    if(keys["ArrowLeft"]||touch.left) ship.angle-=ship.rotation;
    if(keys["ArrowRight"]||touch.right) ship.angle+=ship.rotation;
    if(keys["ArrowUp"]||touch.thrust){
      ship.vx+=Math.cos(ship.angle)*ship.thrust;
      ship.vy+=Math.sin(ship.angle)*ship.thrust;
    }

    ship.vy+=GRAVITY;
    ship.vx*=DAMPING;
    ship.vy*=DAMPING;
    ship.x+=ship.vx;
    ship.y+=ship.vy;
    wrap(ship,ship.radius);

    if((keys[" "]||touch.fire)&&ship.cooldown<=0){
      bullets.push({x:ship.x,y:ship.y,vx:Math.cos(ship.angle)*6,vy:Math.sin(ship.angle)*6,l:90});
      beep(600,0.05);
      ship.cooldown=10;
    }
    ship.cooldown--;
  }

  /* BULLETS */
  bullets.forEach(b=>{b.x+=b.vx;b.y+=b.vy;b.l--;wrap(b,2);});
  bullets=bullets.filter(b=>b.l>0);

  /* ASTEROIDS */
  asteroids.forEach(a=>{a.x+=a.vx;a.y+=a.vy;a.a+=a.s;wrap(a,a.size);});

  /* COLLISIONS */
  for(let i=bullets.length-1;i>=0;i--)
    for(let j=asteroids.length-1;j>=0;j--){
      if(Math.hypot(bullets[i].x-asteroids[j].x,bullets[i].y-asteroids[j].y)<asteroids[j].size){
        const a=asteroids.splice(j,1)[0];
        bullets.splice(i,1);
        explode(a.x,a.y,20);
        beep(200,0.1);
        score+=100;
        document.getElementById("score").textContent="SCORE: "+score;
        if(a.size>30){
          spawnAsteroid(a.size/2,a.x,a.y);
          spawnAsteroid(a.size/2,a.x,a.y);
        }
        break;
      }
    }

  /* SHIP HIT */
  if(!dead)
    asteroids.forEach(a=>{
      if(Math.hypot(ship.x-a.x,ship.y-a.y)<ship.radius+a.size){
        dead=true;
        resetTimer=60;
        explode(ship.x,ship.y,40);
        beep(80,0.3);
      }
    });
  else if(--resetTimer<=0) resetGame();

  /* PARTICLES */
  ctx.fillStyle="orange";
  particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.l--;ctx.fillRect(p.x,p.y,2,2);});
  particles=particles.filter(p=>p.l>0);

  /* DRAW SHIP */
  if(!dead){
    ctx.save();
    ctx.translate(ship.x,ship.y);
    ctx.rotate(ship.angle);
    ctx.strokeStyle="cyan";
    ctx.beginPath();
    ctx.moveTo(12,0);
    ctx.lineTo(-10,-8);
    ctx.lineTo(-6,0);
    ctx.lineTo(-10,8);
    ctx.closePath();
    ctx.stroke();
    ctx.restore();
  }

  /* BULLETS */
  ctx.fillStyle="white";
  bullets.forEach(b=>ctx.fillRect(b.x-2,b.y-2,4,4));

  /* ASTEROIDS */
  asteroids.forEach(a=>{
    ctx.save();
    ctx.translate(a.x,a.y);
    ctx.rotate(a.a);
    ctx.beginPath();
    a.shape.forEach((p,i)=>{
      const x=Math.cos(p.a)*p.r;
      const y=Math.sin(p.a)*p.r;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    });
    ctx.closePath();
    ctx.fillStyle="#777";
    ctx.strokeStyle="#aaa";
    ctx.fill();
    ctx.stroke();
    ctx.restore();
  });

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
